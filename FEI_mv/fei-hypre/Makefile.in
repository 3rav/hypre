#BHEADER***********************************************************************
# (c) 1999   The Regents of the University of California
#
# See the file COPYRIGHT_and_DISCLAIMER for a complete copyright
# notice, contact person, and disclaimer.
#EHEADER***********************************************************************

.SUFFIXES: .cxx .c .f .o

HYPRE_ARCH = @ARCH@

srcdir = @srcdir@
VPATH = @srcdir@

CC = @CC@
CXX = @CXX@

#FEI_BASE_DIR = @FEI_BASE_DIR@
FEI_BASE_DIR    = $$HYPRE_FEI_BASE_DIR
SUPERLU_INCLUDE = -I$(srcdir)/../SuperLU
SUPERLU_LIB     = -L$(srcdir)/../SuperLU
MLPACK_INCLUDE  = 
MLPACK_LIB      =

C_COMPILE_FLAGS=@CFLAGS@
C_SUPERLU_FLAGS=@CSUPERLUFLAGS@
CXX_COMPILE_FLAGS=@CXXFLAGS@
CINCLUDES=@INCLUDES@ @MPIINCLUDE@
CXXINCLUDES=@INCLUDES@ @MPIINCLUDE@
CDEFS = -DHAVE_SUPERLU -DBOOL_NOT_SUPPORTED
CXXDEFS = -DHAVE_SUPERLU -DBOOL_NOT_SUPPORTED -DMPICH_SKIP_MPICXX

CFLAGS = -w ${C_COMPILE_FLAGS} ${CDEFS}\
 ${C_SUPERLU_FLAGS}\
 -I../..\
 -I$(srcdir)\
 -I$(srcdir)/../..\
 -I$(srcdir)/../../IJ_mv\
 -I$(srcdir)/../../utilities\
 -I$(srcdir)/../../krylov\
 -I$(srcdir)/../../parcsr_mv\
 -I$(srcdir)/../../parcsr_ls\
 -I$(srcdir)/../../seq_mv\
 -I$(srcdir)/../../distributed_matrix\
 -I$(srcdir)/../../distributed_ls\
 -I$(srcdir)/../femli\
 -I$(FEI_BASE_DIR)\
 ${SUPERLU_INCLUDE}\
 ${MLPACK_INCLUDE}\
 ${CINCLUDES}

MPILIBFLAGS = @MPILIBDIRS@ @MPILIBS@ @MPIFLAGS@
CXXFLAGS = -w ${CXX_COMPILE_FLAGS} ${CXXDEFS}\
 ${C_SUPERLU_FLAGS}\
 -I../..\
 -I$(srcdir)/../..\
 -I$(srcdir)/../../IJ_mv\
 -I$(srcdir)/../../utilities\
 -I$(srcdir)/../../krylov\
 -I$(srcdir)/../../parcsr_mv\
 -I$(srcdir)/../../parcsr_ls\
 -I$(srcdir)/../../seq_mv\
 -I$(srcdir)/../femli\
 -I$(FEI_BASE_DIR)\
 ${SUPERLU_INCLUDE}\
 ${CXXINCLUDES}

MPILIBFLAGS = @MPILIBDIRS@ @MPILIBS@ @MPIFLAGS@
LIBFLAGS = @LIBDIRS@ @LIBS@
LDLIBFLAGS = @LDLIBDIRS@ @LDLIBS@

MPI_LIBS = -lpmpich -lmpich -lrpc -lgs -lpthread

RANLIB = @RANLIB@

LFLAGS =\
 -L.\
 -L../../hypre/lib\
 ${SUPERLU_LIB} ${MLPACK_LIB}\
 -lHYPRE_FEI\
 -lHYPRE_FEI_BASE\
 -lHYPRE_parcsr_ls \
 -lHYPRE_ParaSails \
 -lHYPRE_FEI_isismv \
 -lHYPRE_IJ_mv \
 -lml \
 -lHYPRE_utilities \
 -lHYPRE_parcsr_mv \
 -lHYPRE_MatrixMatrix \
 -lHYPRE_DistributedMatrix \
 -lHYPRE_DistributedMatrixPilutSolver \
 -lHYPRE_superlu \
 -lHYPRE_seq_mv \
 ${MPILIBFLAGS} ${MPI_LIBS} ${LIBFLAGS} ${LDLIBFLAGS}\
 -ldxml -lm

FILES = HYPRE_LinSysCore.cxx HYPRE_LSC_aux.cxx cfei_hypre.cxx \
        hypre_slide_reduce.cxx \
        hypre_schur_reduce.cxx hypre_lsi_misc.c hypre_lsi_ddamg.cxx \
        HYPRE_LSI_ml.c HYPRE_LSI_ddilut.c hypre_lsi_amge.c \
        HYPRE_parcsr_bicgstabl.c bicgstabl.c \
        HYPRE_LSI_poly.c HYPRE_LSI_ddict.c HYPRE_parcsr_TFQmr.c \
        TFQmr.c HYPRE_parcsr_bicgs.c bicgs.c HYPRE_LSI_schwarz.c \
        HYPRE_LSI_blkprec.cxx HYPRE_parcsr_symqmr.c SymQMR.c \
        HYPRE_parcsr_fgmres.c fgmres.c HYPRE_LSI_mli.cxx \
        HYPRE_SlideReduction.cxx HYPRE_LSI_UZAWA.cxx HYPRE_LSI_Dsuperlu.c \
        HYPRE_parcsr_lsicg.c lsicg.c FEI_HYPRE_Impl.cxx

TEMP = ${FILES:.c=.o}
OBJS = ${TEMP:.cxx=.o}

##################################################################
# Main rules
##################################################################

all: libHYPRE_FEI.a

lib: all

install: all
	@cp -f $(srcdir)/HYPRE_LinSysCore.h $$HYPRE_INSTALL_DIR/include
	@cp -f $(srcdir)/../fei-base/Lookup.h $$HYPRE_INSTALL_DIR/include
	@cp -f $(srcdir)/../fei-base/LinearSystemCore.h \
         $$HYPRE_INSTALL_DIR/include/snl_LinearSystemCore.h
	@cp -f $(srcdir)/../fei-base/fei_defs.h $$HYPRE_INSTALL_DIR/include
	@cp -f $(srcdir)/cfei_hypre.h $$HYPRE_INSTALL_DIR/include
	@cp -f $(srcdir)/cfei-hypre.h $$HYPRE_INSTALL_DIR/include
	@cp -f $(srcdir)/HYPRE_FEI_includes.h $$HYPRE_INSTALL_DIR/include
	@cp -f libHYPRE_FEI.a $$HYPRE_INSTALL_DIR/lib

driver: driver.o libHYPRE_FEI.a
	@echo  "Linking" $@ "... "
	${CXX} -o $@ driver.o ${LFLAGS}

libHYPRE_FEI.a: ${OBJS}
	@echo  "Building $@ ... "
	@${AR} -rcu libHYPRE_FEI.a ${OBJS}
	${RANLIB} $@

##################################################################
# Targets
##################################################################

clean:
	@touch erase.tmp
	@rm -rf erase.tmp *.o ti_files driver

veryclean: clean
	@touch erase.tmp
	@rm -rf erase.tmp *.o *.a ti_files driver


##################################################################
# Generic rules
##################################################################

.cxx.o:
	${CXX} -o $@ ${DEFINES} -c ${CXXFLAGS} $<

.c.o:
	${CC} -o $@ ${DEFINES} -c ${CFLAGS} $<

