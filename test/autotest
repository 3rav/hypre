#!/bin/sh
#BHEADER***********************************************************************
# (c) 1998   The Regents of the University of California
#
# See the file COPYRIGHT_and_DISCLAIMER for a complete copyright
# notice, contact person, and disclaimer.
#
# $Revision$
#EHEADER***********************************************************************

#==============================================================================
# Environment variables
# NOTE: this should be stripped down to something more minimal
#==============================================================================

CVSROOT=/home/casc/repository
export CVSROOT

PATH=/home/casc/bin:\
/opt/SUNWspro/bin:/usr/ccs/bin:/usr/local/bin:\
/usr/sbin:/usr/bin:/usr/ucb:\
/sbin/bin:\
/usr/local/scripts:\
/usr/local/mpi/mpich/bin
export PATH

#==============================================================================
# Set autotest directory (assumes CASC cluster)
#==============================================================================

HYPRE_AUTOTEST_DIR="/home/casc/software/hypre/autotest"

#=============================================================================
# Check out the repository in the HYPRE_AUTOTEST_DIR directory
#=============================================================================

if [ ! -d "$CVSROOT" ]
then
    echo "Error: no CVS repository, CVSROOT = $CVSROOT"
    exit
fi

cd $HYPRE_AUTOTEST_DIR
rm -fR linear_solvers
cvs checkout -P linear_solvers

#=============================================================================
# Make libraries and test drivers
#=============================================================================

cd linear_solvers
./configure
make

#=============================================================================
# Run script to test all driver programs 
#=============================================================================

cd test
./test_drivers.sh -mail

#=============================================================================
# Clean up
#=============================================================================

make veryclean

#==============================================================================
# Set permissions so that all developers can access
#  -- give everyone read and execute permission
#  -- give group write permissions
#==============================================================================

echo "setting permissions...."
chmod -fR a+rX,ug+w $HYPRE_AUTOTEST_DIR

#==============================================================================
# Run test suites on remote machines
#==============================================================================

cd $HYPRE_AUTOTEST_DIR

while [ "$*" != "" ]
do

case $1 in
    -dec)
        HYPRE_COMPILE_MACHINE="west"
        HYPRE_RUN_MACHINE="northwest"
        HYPRE_REMOTE_DIR=AUTOTEST
        shift;;
    -blue)
        HYPRE_COMPILE_MACHINE="blue"
        HYPRE_RUN_MACHINE="blue"
        HYPRE_REMOTE_DIR=AUTOTEST
        shift;;
    -red)
        HYPRE_COMPILE_MACHINE="sasn100"
        HYPRE_RUN_MACHINE="janus"
        HYPRE_REMOTE_DIR=AUTOTEST
        shift;;
esac

# remove old source
ssh ${HYPRE_COMPILE_MACHINE} '(cd ${HYPRE_REMOTE_DIR}; rm -fr *)'

# copy source over
scp -r * ${HYPRE_COMPILE_MACHINE}:${HYPRE_REMOTE_DIR}

# compile
ssh ${HYPRE_COMPILE_MACHINE} '\
    (\
	cd ${HYPRE_REMOTE_DIR}/linear_solvers;\
	./configure;\
	make\
    )'

# run test suite
ssh ${HYPRE_RUN_MACHINE} '\
    (\
	cd ${HYPRE_REMOTE_DIR}/linear_solvers/test;\
	./test_drivers.sh -mail\
    )'

done
