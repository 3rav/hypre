#BHEADER***********************************************************************
# (c) 1999   The Regents of the University of California
#
# See the file COPYRIGHT_and_DISCLAIMER for a complete copyright
# notice, contact person, and disclaimer.
#
# $Revision$
#EHEADER***********************************************************************

.SUFFIXES: .C .c .f .o

HYPRE_ARCH = @ARCH@

srcdir = @srcdir@

CC = @CC@
CXX = @CXX@

SUPERLU_INCLUDE = -I/g/g2/chtong/SUPERLU/WEST/SuperLU/SRC
SUPERLU_LIB     = -L/g/g2/chtong/SUPERLU/WEST/SuperLU
MLPACK_INCLUDE  = -I/g/g2/chtong/ML/WEST/ml/src
MLPACK_LIB      = -L/g/g2/chtong/ML/WEST/ml/src

C_COMPILE_FLAGS=@CFLAGS@
CXX_COMPILE_FLAGS=@CXXFLAGS@
CINCLUDES=@INCLUDES@ @MPIINCLUDE@
CXXINCLUDES=@INCLUDES@ @MPIINCLUDE@
#CDEFS = -DHYPRE_NO_PTHREAD_MANGLING -DSUPERLU -DMLPACK
#CXXDEFS = -DHYPRE_NO_PTHREAD_MANGLING -DSUPERLU -DMLPACK
CDEFS = -DHYPRE_NO_PTHREAD_MANGLING 
CXXDEFS = -DHYPRE_NO_PTHREAD_MANGLING 

CFLAGS = -w ${C_COMPILE_FLAGS} \
 ${CDEFS}\
 -I../..\
 -I../../IJ_matrix_vector\
 -I../../utilities\
 -I../../parcsr_matrix_vector\
 -I../../parcsr_linear_solvers\
 -I../../seq_matrix_vector\
 -I../../distributed_matrix\
 -I../../distributed_linear_solvers\
 -I../fei-base\
 ${SUPERLU_INCLUDE}\
 ${MLPACK_INCLUDE}\
 ${CINCLUDES}

MPILIBFLAGS = @MPILIBDIRS@ @MPILIBS@ @MPIFLAGS@
CXXFLAGS = -w ${CXX_COMPILE_FLAGS} \
 ${CXXDEFS}\
 -I../..\
 -I../../IJ_matrix_vector\
 -I../../utilities\
 -I../../parcsr_matrix_vector\
 -I../../parcsr_linear_solvers\
 -I../../seq_matrix_vector\
 -I../fei-base\
 ${SUPERLU_INCLUDE}\
 ${CXXINCLUDES}

MPILIBFLAGS = @MPILIBDIRS@ @MPILIBS@ @MPIFLAGS@
LIBFLAGS = @LIBDIRS@ @LIBS@
LDLIBFLAGS = @LDLIBDIRS@ @LDLIBS@

MPI_LIBS = -lpmpich -lmpich -lrpc -lgs -lpthread

RANLIB = @RANLIB@

LFLAGS =\
 -L.\
 -L../../hypre/lib\
 ${SUPERLU_LIB} ${MLPACK_LIB}\
 -lHYPRE_FEI\
 -lHYPRE_FEI_BASE\
 -lHYPRE_parcsr_ls \
 -lHYPRE_ParaSails \
 -lHYPRE_FEI_isismv \
 -lHYPRE_IJ_mv \
 -lml \
 -lHYPRE_utilities \
 -lHYPRE_parcsr_mv \
 -lHYPRE_MatrixMatrix \
 -lHYPRE_DistributedMatrix \
 -lHYPRE_DistributedMatrixPilutSolver \
 -lsuperlu_alpha \
 -lHYPRE_seq_mv \
 ${MPILIBFLAGS} ${MPI_LIBS} ${LIBFLAGS} ${LDLIBFLAGS}\
 -ldxml -lm

FILES = HYPRE_LinSysCore.C cfei_hypre.C hypre_slide_reduce.C \
        hypre_schur_reduce.C hypre_lsi_misc.c hypre_lsi_ddamg.C \
        HYPRE_parcsr_ml.c hypre_lsi_ddilut.c

TEMP = ${FILES:.c=.o}
OBJS = ${TEMP:.C=.o}

FILESV12 = HYPRE_LinSysCore.C hypre_slide_reduce.C \
           hypre_schur_reduce.C hypre_lsi_misc.c hypre_lsi_ddamg.C \
           HYPRE_parcsr_ml.c hypre_lsi_ddilut.c

TEMPV12 = ${FILESV12:.c=.o}
OBJSV12 = ${TEMPV12:.C=.o}

##################################################################
# Main rules
##################################################################

all: libHYPRE_FEI.a

lib: all

install: all
	@cp -f HYPRE_LinSysCore.h $$HYPRE_INSTALL_DIR/include
	@cp -f cfei_hypre.h $$HYPRE_INSTALL_DIR/include
	@cp -f cfei-hypre.h $$HYPRE_INSTALL_DIR/include
	@cp -f libHYPRE_FEI.a $$HYPRE_INSTALL_DIR/lib

driver: driver.o libHYPRE_FEI.a
	@echo  "Linking" $@ "... "
	${CXX} -o $@ driver.o ${LFLAGS}

libHYPRE_FEI.a: ${OBJS}
	@echo  "Building $@ ... "
	@ar -rcu libHYPRE_FEI.a ${OBJS}
	${RANLIB} $@

libHYPRE_FEI_V12.a: ${OBJSV12}
	@echo  "Building $@ ... "
	${CXX} -o $@ -c ${CXXFLAGS} -DFEI_V1.2 HYPRE_LinSysCore.C
	@ar -rcu libHYPRE_FEI_V12.a ${OBJSV12}
	${RANLIB} $@

##################################################################
# Targets
##################################################################

clean:
	@touch erase.tmp
	@rm -rf erase.tmp *.o ti_files driver

veryclean: clean
	@touch erase.tmp
	@rm -rf erase.tmp *.o *.a ti_files driver


##################################################################
# Generic rules
##################################################################

.C.o:
	${CXX} -o $@ -c ${CXXFLAGS} $<

.c.o:
	${CC} -o $@ -c ${CFLAGS} $<

